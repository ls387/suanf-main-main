# 冲突计数修复说明

## ✅ 已修复的问题

### 问题描述

冲突检测结果数量不准确：

- **实际冲突**：4 个（图片显示）
- **报告冲突**：8 个（之前的输出）
- **原因**：按时间节重复计数

### 根本原因

旧逻辑按每个时间节（slot）检测冲突，导致多节课的冲突被重复计数。

**示例**：

- 课程 A 和 B 冲突，都占用周一第 6-7 节（共 2 节）
- 旧逻辑：
  - 第 6 节检测到冲突 → 报告 1 次
  - 第 7 节检测到冲突 → 报告 1 次
  - **总计**：2 次 ❌
- 新逻辑：
  - 识别为 1 对课程的时间段重叠
  - **总计**：1 次 ✅

## 🔧 修复内容

### 1. 冲突检测逻辑重构

**班级冲突、教师冲突、教室冲突** 全部改为：

```python
# 新逻辑：基于schedule_id和时间段
1. 构建包含schedule_id和完整时间信息的数据结构
2. 检测课程对之间的时间段重叠（而非单个时间节）
3. 使用set去重：(resource_id, (schedule_id1, schedule_id2))
4. 每对课程只报告一次
```

### 2. 显示格式优化

冲突信息现在显示：

```
冲突 #1:
  班级: 智能制造2025-05班
  时间: 周一 第6-6节              # 显示重叠时间段
  课程1: 高等数学I (5-6节) - ...  # 显示完整课程时间
  课程2: 制图与CAD基础 (6-8节) - ...
```

### 3. Excel 导出修复

更新导出字段：

- 旧字段：`conflict["slot"]` ❌
- 新字段：`conflict["overlap_start"]` 和 `conflict["overlap_end"]` ✅
- 显示格式：`6-7节` 或 `6节`

## 📊 验证结果

运行 `python analyze_conflicts.py 1` 后：

```
【班级时间冲突分析】
冲突 #1: 智能制造2025-05班 - 周一第6节 - 高等数学I vs 制图与CAD基础
冲突 #2: 智能制造2025-05班 - 周一第6节 - 高等数学I vs 线性代数B
冲突 #3: 智能制造2025-05班 - 周一第6-8节 - 制图与CAD基础 vs 线性代数B
冲突 #4: 新能源2025-01班 - 周一第6节 - 高等数学I vs 线性代数B

⚠ 共发现 4 处班级冲突  ← 准确数量！
```

### 冲突分析

从结果看，实际有以下冲突情况：

**智能制造 2025-05 班 周一**:

- 第 5-6 节：高等数学 I
- 第 6-8 节：制图与 CAD 基础 } 第 6 节冲突
- 第 6-8 节：线性代数 B } 第 6-8 节冲突

这是一个"三角冲突"：

1. 高等数学 I vs 制图与 CAD 基础（第 6 节）
2. 高等数学 I vs 线性代数 B（第 6 节）
3. 制图与 CAD 基础 vs 线性代数 B（第 6-8 节）

✅ **3 个冲突对，统计准确！**

**新能源 2025-01 班 周一**:

- 第 5-6 节：高等数学 I
- 第 6-8 节：线性代数 B } 第 6 节冲突

✅ **1 个冲突对，统计准确！**

**总计**：4 个冲突对 = 4 处冲突 ✅

## 🎯 修复效果

| 项目       | 修复前   | 修复后   | 改进 |
| ---------- | -------- | -------- | ---- |
| 计数方式   | 按时间节 | 按课程对 | ✅   |
| 重复计数   | 有       | 无       | ✅   |
| 统计准确性 | 不准确   | 准确     | ✅   |
| Excel 导出 | 报错     | 正常     | ✅   |
| 显示格式   | 单节     | 时间段   | ✅   |

## 📝 技术细节

### 修改的函数

1. `analyze_schedule_conflicts()` - 班级/教师/教室冲突检测
2. `export_conflicts_to_excel()` - Excel 导出格式

### 新增数据结构

```python
# 去重集合
conflict_pairs = set()  # (class_id, (schedule_id1, schedule_id2))
teacher_conflict_pairs = set()
classroom_conflict_pairs = set()

# 课程完整信息
{
    "schedule_id": xxx,
    "weekday": 1,
    "start_slot": 6,
    "end_slot": 8,
    "course": "...",
    "weeks": {3,4,5,...}
}
```

### 关键改进

- ✅ 基于 schedule_id 去重
- ✅ 检测时间段重叠而非单个时间节
- ✅ 显示重叠时间段范围
- ✅ Excel 显示格式优化

## 🚀 使用方法

```bash
# 分析冲突（现在统计准确）
python analyze_conflicts.py 1

# 导出Excel（现在不会报错）
# 会自动生成：排课冲突报告_版本1_YYYYMMDD_HHMMSS.xlsx
```

## ✅ 总结

- **问题**：冲突重复计数
- **原因**：按时间节统计
- **修复**：按课程对统计 + set 去重
- **效果**：统计准确，显示清晰
- **验证**：4 个冲突 = 实际冲突数量 ✅
