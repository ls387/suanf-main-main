# 排课系统说明文档

本文档为开发者/运维/使用者提供一份独立、可读的说明，帮助快速理解代码实现的排课逻辑、功能、操作方法、优点与局限，不依赖旧文档。

**适用范围**

- 仓库位置：`d:\suanf-main-main`
- 忽略文件：`test_data_generator.py`（不在本次说明范围）

---

## 一、系统概览

这是一个基于遗传算法的智能排课系统，主要模块如下：

- `suan2.py`：主程序入口，负责参数解析、数据库连接、运行遗传算法并保存结果；
- `data_models.py`：数据模型定义（教学任务、教师、班级、教室、基因等）；
- `db_connector.py`：数据库连接与数据加载/保存逻辑；
- `genetic_algorithm.py`：遗传算法实现（生成个体、适应度评估、选择/交叉/变异、冲突修复、后处理）；
- `view_schedule.py`：导出/查看排课结果（打印并导出 Excel）；
- `analyze_conflicts.py`：对已保存排课结果做冲突分析；
- `check_data_scale.py`：检查数据库数据规模并推荐参数。

设计目标：在满足硬约束（不可违）的前提下，通过优化软约束得分，生成高覆盖率、低冲突、教室利用率高的排课方案。

---

## 二、核心排课逻辑（实现细节，便于他人理解）

1. 数据模型

- `TeachingTask`：每一个教学任务包含 `task_id`, `offering_id`, `group_id`, `slots_count`, 并在加载后填充 `teachers` (可授课教师列表)、`classes` (涉及班级列表)、`student_count`、`required_features`、`offering` 等。
- `Gene`：表示单个任务的排课结果，包含 `task_id`, `teacher_id`, `classroom_id`, `week_day`, `start_slot`。

2. 预处理

- 读取数据库，填充教学任务的教师、班级、人数与必需教室特征；
- 按优先级对任务排序（长课优先，必修/通识优先，大班优先等）；
- 构建教室按容量排序、教师黑名单时间与偏好映射等查询表。

3. 个体生成（create_individual / \_create_gene_for_task）

- 按任务优先级顺序，为每个任务尝试分配时间、教师与教室：
  - 先在“偏好时间”中随机尝试若干次（工作日 1-5），再在其他可用时间尝试；
  - 在尝试过程中检查：教师黑名单、教师时间冲突、班级时间冲突、教室可用性（容量、特征、时间占用）；
  - 选择教室时使用容量匹配或利用率评分函数，优先匹配容量接近学生数的教室。

4. 适应度函数（fitness）

- 先计算时间占用表（教师/班级/教室）并调用 `_check_hard_constraints`：
  - 硬约束包括教师/班级/教室冲突、教室容量不足、必需设施缺失、教师黑名单、周四下午限制、校区通勤等；
  - 任何硬约束严重违反会导致非常低的惩罚（大负分），使该个体不被选中。
- 若硬约束通过，继续计算软约束惩罚 `_check_soft_constraints`（教师偏好、教室连续性、利用率浪费、学生日负荷、课程时段偏好等），并据此调整分数。

5. 遗传操作

- 选择：使用锦标赛选择（tournament selection）保留更优个体；
- 交叉：单点交叉合并父代基因片段；
- 变异：包含多种变异类型（更换教师、时间、教室），并增加 `smart_repair` 智能修复操作以解决冲突；
- 变异中 `smart_repair` 会尝试在不冲突的时段修复基因，优先避免班级冲突。

6. 修复与后处理

- 在变异阶段与后处理步骤中增加冲突修复：
  - `_repair_conflicting_gene`：尝试为冲突基因寻找新的合法时间/教室，优先解决班级冲突；
  - 进化完成后 `_post_process_class_conflicts`：针对残留的班级冲突逐个尝试修复（对若干冲突做额外尝试），提高最终方案质量。

7. 输出与保存

- 最佳个体经过后处理后写入数据库表 `schedules`（或项目中约定的表名），可用 `view_schedule.py` 导出 Excel 并在控制台打印摘要。

---

## 三、实现功能清单（直接可见）

- 从数据库加载完整的教学任务、教师、班级、教室与偏好/黑名单数据；
- 自动优先级排序并生成初始种群；
- 遗传算法主循环（选择/交叉/变异/精英保留/停滞检测）；
- 硬约束判定与软约束惩罚体系；
- 智能的教室选择（容量与特征匹配、利用率优化）；
- 冲突修复机制（变异中的智能修复 + 进化结果的后处理）；
- 保存排课结果到数据库并能导出 Excel；
- 结果冲突分析工具与利用率统计；
- 数据规模检测并给出参数建议脚本。

---

## 四、如何操作（快速上手）

1. 环境准备（Windows PowerShell 示例）：

```powershell
# 建议 Python 版本 >= 3.9
python -m venv .venv
.\.venv\Scripts\activate
pip install pymysql openpyxl
```

2. 设置数据库连接（可用环境变量覆盖默认值）：

```powershell
$env:DB_HOST = "localhost"
$env:DB_USER = "root"
$env:DB_PASSWORD = "123456"
$env:DB_NAME = "paike"
```

3. 检查数据与推荐参数：

```powershell
python check_data_scale.py
```

4. 运行排课（示例）：

```powershell
# 标准运行（推荐）
python suan2.py --version 1 --population 200 --generations 300

# 快速测试
python suan2.py --version 1 --population 80 --generations 100
```

5. 查看/导出结果：

```powershell
python view_schedule.py 1        # 导出并查看版本1的结果（会生成 Excel）
python analyze_conflicts.py 1    # 命令行冲突分析
```

6. 常用参数说明：

- `--version` 必需：排课版本 ID；
- `--population`：种群大小；
- `--generations`：进化代数；
- `--crossover-rate`、`--mutation-rate`、`--elitism-size`、`--max-stagnation`：可选调整，用于控制搜索行为。

---

## 五、该实现的优点

- 可扩展性强：数据模型与算法模块分离，新增约束或软约束只需添加函数与惩罚分数；
- 混合策略：优先级排序 + 遗传进化 + 智能修复 + 后处理，多层次减少冲突；
- 实用性：包含数据库集成、Excel 导出、冲突分析脚本，便于生产环境使用；
- 参数灵活：`check_data_scale.py` 给出推荐，支持用户根据时间/质量取舍；
- 针对性强：提供班级冲突优先修复逻辑，避免学生同时被安排多门课程。

---

## 六、该实现的缺点与限制（现实制约）

- 启发式算法的局限：遗传算法不能保证全局最优，结果受参数与随机种子影响；
- 运行时间与资源：种群/代数较大时，运行时间和内存占用明显增大；
- 数据质量依赖：若数据库中的教师/教室/班级信息不准确（如班级学生数错误），会影响分配效果；
- 约束冲突无法自动解决：当硬约束集合本身无可行解（例如教师/教室严重不足），算法无法找到合法方案，需要人工放宽约束或补充资源；
- 可解释性：虽然有日志与冲突明细，但遗传算法内部演化过程的解释性不如确定性调度算法。

---

## 七、运维与二次开发建议

- 日志级别：开发时启用 `DEBUG` 便于追踪个体演化过程，生产环境保留 `INFO`；
- 单元/集成测试：对 `_has_time_conflict`、`_select_classroom`、适应度函数和修复函数编写测试用例；
- 数据验证：在 `DataLoader` 层加入更多校验（确保 `task.classes`、`task.teachers` 不为空并且引用存在）；
- 可视化：扩展 `view_schedule.py` 以生成更直观的可视化（HTML 或交互式表格）；
- 参数调优：在生产环境建立定期基准测试以获得最佳 `population` / `generations` 配置。

---

## 八、常见问题与快速排查

- 问：为什么有班级冲突？

  - 检查 `teaching_tasks` 是否为每个任务正确填充 `classes`；
  - 检查给定 `population` / `generations` 是否足够；
  - 查看日志中 `_post_process_class_conflicts` 是否修复了冲突。

- 问：为什么教室利用率低？

  - 检查教室容量分布是否与班级规模匹配；
  - 尝试提高 `utilization_waste` 惩罚权重或优化 `classroom` 选择函数。

- 问：运行时间太长如何处理？
  - 降低 `population` 或 `generations`；
  - 使用 `max_stagnation` 较小值以提前停止；
  - 分阶段运行（快速探索 → 标准运行 → 深度优化）。

---

## 九、文件与关键函数索引（便于定位）

- `suan2.py`:

  - 入口 `main()` -> `SchedulingSystem.run_scheduling()`
  - `_check_conflicts()`、`_generate_report()` 在此模块内用于报告输出

- `db_connector.py`:

  - `DataLoader.load_all_data(semester)`：加载并组装所有数据为内存对象
  - `save_schedule_results()`：把结果写回 `schedules` 表

- `genetic_algorithm.py`（核心）:

  - `create_individual()` / `_create_gene_for_task()`：个体与基因创建
  - `fitness()`：适应度计算（硬约束 + 软约束）
  - `crossover()` / `mutate()` / `tournament_selection()`：遗传操作
  - `_repair_conflicting_gene()`：智能修复冲突
  - `_post_process_class_conflicts()`：进化完成后的班级冲突后处理

- `data_models.py`:

  - `TeachingTask`, `Teacher`, `Class`, `Classroom`, `Gene` 等数据结构定义

- `view_schedule.py`, `analyze_conflicts.py` :
  - 结果导出、冲突分析与 Excel 报表相关代码

---

## 十、交付物

- 本文件：`d:\suanf-main-main\排课系统说明.md`（已保存）
- 建议后续：在代码库根目录加入 `docs/` 目录，将本说明与 `使用指南`、`开发者指南` 分开管理。

---

如需，我可以：

- 将本说明翻译为英文版本；
- 根据你需要，生成一个更短的“快速上手”一页说明；
- 或把关键命令集成到 `Makefile` / PowerShell 脚本以便一键运行。
