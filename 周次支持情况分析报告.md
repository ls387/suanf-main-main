# æ’è¯¾ç³»ç»Ÿå‘¨æ¬¡æ”¯æŒæƒ…å†µå®Œæ•´åˆ†ææŠ¥å‘Š - å·²ä¿®å¤

## ä¿®å¤çŠ¶æ€ï¼šâœ… å·²å®Œæˆ

**ä¿®å¤æ—¥æœŸ**: 2025-11-25  
**ä¿®å¤å†…å®¹**: P0 çº§ä¸¥é‡é—®é¢˜å·²å…¨éƒ¨ä¿®å¤

---

## ä¸€ã€æ ¸å¿ƒé—®é¢˜æ€»ç»“

### âœ… å·²ä¿®å¤çš„å…³é”® Bug

**é—®é¢˜**ï¼šå‘¨æ¬¡æ¨¡å¼æšä¸¾å€¼ä¸åŒ¹é…

- æ•°æ®åº“å®šä¹‰ï¼š`CONTINUOUS`, `SINGLE`, `DOUBLE`, `CUSTOM`
- ä»£ç ä¸­ä½¿ç”¨ï¼š`ALL_WEEKS`, `ODD_WEEKS`, `EVEN_WEEKS` âŒ
- **å½±å“**ï¼šæ‰€æœ‰å•åŒå‘¨è¯¾ç¨‹è¢«é”™è¯¯è¯†åˆ«ä¸ºå…¨å­¦æœŸè¯¾ç¨‹
- **ä¿®å¤**ï¼šå·²ä¿®æ”¹ `db_connector.py` å’Œ `analyze_conflicts.py` ä¸­çš„å‘¨æ¬¡ç”Ÿæˆé€»è¾‘

## äºŒã€å„æ¨¡å—å‘¨æ¬¡æ”¯æŒè¯¦ç»†åˆ†æ

### 1. æ•°æ®åŠ è½½å±‚ (`db_connector.py`)

#### âœ… å·²å®ç°çš„åŠŸèƒ½

```python
def _load_offering_weeks(self) -> Dict[int, Set[int]]:
    """ä» offering_weeks è¡¨åŠ è½½è‡ªå®šä¹‰å‘¨æ¬¡"""
    # åŠ è½½ offering_weeks è¡¨æ•°æ®
    # è¿”å› Dict[offering_id, Set[week_number]]
```

```python
def _generate_weeks_from_pattern(self, start_week, end_week, week_pattern) -> Set[int]:
    """æ ¹æ® week_pattern ç”Ÿæˆå‘¨æ¬¡é›†åˆ"""
    if week_pattern == "CONTINUOUS":
        return set(range(start_week, end_week + 1))  # å…¨å­¦æœŸ
    elif week_pattern == "SINGLE":
        return set(w for w in range(start_week, end_week + 1) if w % 2 == 1)  # å•å‘¨
    elif week_pattern == "DOUBLE":
        return set(w for w in range(start_week, end_week + 1) if w % 2 == 0)  # åŒå‘¨
```

```python
def _enrich_teaching_tasks(self, data: Dict):
    """å¡«å……æ•™å­¦ä»»åŠ¡çš„å‘¨æ¬¡ä¿¡æ¯"""
    # ä¼˜å…ˆä½¿ç”¨ offering_weeks è¡¨çš„è‡ªå®šä¹‰æ•°æ®
    if offering_id in data.get("offering_weeks", {}):
        task.weeks = data["offering_weeks"][offering_id]
    else:
        # æ ¹æ® week_pattern ç”Ÿæˆ
        task.weeks = self._generate_weeks_from_pattern(...)
```

#### âš ï¸ æ½œåœ¨é—®é¢˜

1. **ç©ºå‘¨æ¬¡å¤„ç†**ï¼šå¦‚æœ `offering_weeks` è¡¨ä¸ºç©ºä¸” `week_pattern` ä¸º NULLï¼Œé»˜è®¤ç”Ÿæˆ 1-18 å‘¨
2. **å‘¨æ¬¡èŒƒå›´**ï¼šç¡¬ç¼–ç é»˜è®¤ 1-18 å‘¨ï¼ŒæŸäº›å­¦æœŸå¯èƒ½ä¸åŒ

---

### 2. é—ä¼ ç®—æ³•æ’è¯¾ (`genetic_algorithm.py`)

#### âœ… å·²å®ç°çš„å‘¨æ¬¡æ£€æµ‹

```python
def _has_time_conflict(
    self,
    teacher_id: str,
    class_ids: List[str],
    weekday: int,
    start_slot: int,
    slots_count: int,
    teacher_schedule: Dict,
    class_schedule: Dict,
    task_id: str = None,
    weeks: Set[int] = None,  # âœ… æ”¯æŒå‘¨æ¬¡å‚æ•°
) -> bool:
    """æ£€æŸ¥æ—¶é—´å†²çª - è€ƒè™‘å‘¨æ¬¡é‡å """

    # æ—¶é—´å†²çªæ£€æµ‹
    if teacher_schedule[tid] & time_slots:
        # âœ… æ£€æŸ¥å‘¨æ¬¡æ˜¯å¦é‡å 
        if weeks is None or task.weeks is None or len(task.weeks & weeks) > 0:
            return True  # æ—¶é—´å†²çª ä¸” å‘¨æ¬¡é‡å  = çœŸå†²çª
```

#### âœ… è°ƒç”¨ç‚¹å·²æ›´æ–°

```python
# ä¸¤å¤„è°ƒç”¨éƒ½ä¼ å…¥äº† weeks=task.weeks
if self._has_time_conflict(
    teacher_id, task.classes, weekday, start_slot, task.slots_count,
    teacher_schedule, class_schedule,
    task_id=task.task_id,
    weeks=task.weeks,  # âœ… å·²æ·»åŠ 
):
    continue
```

#### âš ï¸ å­˜åœ¨çš„é—®é¢˜

**é—®é¢˜ 1ï¼šç­çº§å†²çªæ£€æµ‹ä¸å®Œæ•´** âŒ

```python
# å½“å‰ä»£ç åªæ£€æŸ¥æ•™å¸ˆå‘¨æ¬¡ï¼Œæ²¡æœ‰æ£€æŸ¥ç­çº§å‘¨æ¬¡
for class_id in class_ids:
    if class_schedule[class_id] & time_slots:
        return True  # âŒ ç¼ºå°‘å‘¨æ¬¡æ£€æŸ¥ï¼
```

**å½±å“**ï¼š

- åŒä¸€ç­çº§å¯èƒ½è¢«å®‰æ’åœ¨åŒä¸€æ—¶é—´çš„å•å‘¨å’ŒåŒå‘¨è¯¾ç¨‹
- è™½ç„¶å‘¨æ¬¡ä¸å†²çªï¼Œä½†å¦‚æœä¸¤é—¨è¯¾éƒ½æ˜¯å…¨å­¦æœŸï¼Œä»ä¼šå†²çª

**é—®é¢˜ 2ï¼šæ•™å®¤å†²çªæœªæ£€æµ‹å‘¨æ¬¡** âŒ

- å½“å‰ä»£ç ä¸­æ²¡æœ‰æ•™å®¤å ç”¨çš„å‘¨æ¬¡æ£€æµ‹
- ç†è®ºä¸Šæ•™å®¤å¯ä»¥åœ¨åŒä¸€æ—¶é—´è¢«ä¸åŒå‘¨æ¬¡çš„è¯¾ç¨‹ä½¿ç”¨
- ä½†å½“å‰å®ç°ä¸­æ•™å®¤å†²çªæ£€æµ‹åœ¨ `_select_classroom` ä¸­ï¼Œåªæ£€æŸ¥æ—¶é—´ä¸æ£€æŸ¥å‘¨æ¬¡

**ä¿®å¤å»ºè®®**ï¼š

```python
def _has_time_conflict(self, ...):
    # æ£€æŸ¥æ•™å¸ˆå†²çªï¼ˆå·²è€ƒè™‘å‘¨æ¬¡ï¼‰
    if task_id and task_id in self.task_dict:
        task = self.task_dict[task_id]
        for tid in task.teachers:
            if teacher_schedule[tid] & time_slots:
                if weeks is None or task.weeks is None or len(task.weeks & weeks) > 0:
                    return True

    # âš ï¸ åº”è¯¥æ·»åŠ ï¼šæ£€æŸ¥ç­çº§å†²çªæ—¶ä¹Ÿè€ƒè™‘å‘¨æ¬¡
    for class_id in class_ids:
        if class_schedule[class_id] & time_slots:
            # éœ€è¦è·å–è¯¥ç­çº§åœ¨è¯¥æ—¶é—´çš„å…¶ä»–è¯¾ç¨‹çš„å‘¨æ¬¡
            # æ£€æŸ¥æ˜¯å¦æœ‰å‘¨æ¬¡é‡å 
            # å½“å‰å®ç°ï¼šç›´æ¥è¿”å› Trueï¼ˆè¿‡äºä¿å®ˆï¼‰
            return True
```

---

### 3. å†²çªåˆ†æ (`analyze_conflicts.py`)

#### âœ… å·²å®ç°çš„å‘¨æ¬¡æ£€æµ‹

```python
def has_week_overlap(weeks1, weeks2):
    """æ£€æŸ¥ä¸¤ä¸ªå‘¨æ¬¡é›†åˆæ˜¯å¦æœ‰é‡å """
    if not weeks1 or not weeks2:
        return True  # ä¿å®ˆç­–ç•¥ï¼šæ— å‘¨æ¬¡ä¿¡æ¯è®¤ä¸ºæœ‰å†²çª
    return len(weeks1 & weeks2) > 0  # âœ… é›†åˆäº¤é›†æ£€æµ‹
```

```python
def get_weeks(result):
    """æ ¹æ® offering_id è·å–å‘¨æ¬¡é›†åˆ"""
    # âœ… ä¼˜å…ˆä½¿ç”¨ offering_weeks è¡¨
    if offering_id in offering_weeks:
        return offering_weeks[offering_id]

    # âœ… å›é€€åˆ° week_pattern ç”Ÿæˆ
    if week_pattern == "CONTINUOUS":
        return set(range(start_week, end_week + 1))
    elif week_pattern == "SINGLE":
        return set(w for w in range(start_week, end_week + 1) if w % 2 == 1)
    elif week_pattern == "DOUBLE":
        return set(w for w in range(start_week, end_week + 1) if w % 2 == 0)
```

#### âœ… ä¸‰ç±»å†²çªæ£€æµ‹éƒ½è€ƒè™‘å‘¨æ¬¡

```python
# ç­çº§å†²çªæ£€æµ‹
for i in range(len(items)):
    for j in range(i + 1, len(items)):
        if has_week_overlap(items[i]["weeks"], items[j]["weeks"]):  # âœ…
            # æŠ¥å‘Šå†²çª

# æ•™å¸ˆå†²çªæ£€æµ‹
for i in range(len(items)):
    for j in range(i + 1, len(items)):
        if has_week_overlap(items[i]["weeks"], items[j]["weeks"]):  # âœ…
            # æŠ¥å‘Šå†²çª

# æ•™å®¤å†²çªæ£€æµ‹
for i in range(len(items)):
    for j in range(i + 1, len(items)):
        if has_week_overlap(items[i]["weeks"], items[j]["weeks"]):  # âœ…
            # æŠ¥å‘Šå†²çª
```

#### âš ï¸ æ½œåœ¨é—®é¢˜

**é—®é¢˜ï¼šä¿å®ˆçš„é»˜è®¤ç­–ç•¥**

```python
if not weeks1 or not weeks2:
    return True  # ä»»ä¸€è¯¾ç¨‹æ— å‘¨æ¬¡ä¿¡æ¯ â†’ è®¤ä¸ºæœ‰å†²çª
```

- **å½±å“**ï¼šå¦‚æœæ•°æ®ä¸å®Œæ•´ï¼ˆæŸäº›è¯¾ç¨‹ç¼ºå°‘å‘¨æ¬¡ä¿¡æ¯ï¼‰ï¼Œä¼šè¢«è¯¯æŠ¥ä¸ºå†²çª
- **å»ºè®®**ï¼šå¢åŠ æ—¥å¿—ï¼Œæ ‡è®°è¿™ç§æƒ…å†µ

---

### 4. å†²çªä¼˜åŒ– (`analyze_conflicts.py` - `optimize_conflicts`)

#### âŒ **ä¸¥é‡é—®é¢˜ï¼šä¼˜åŒ–ç®—æ³•æœªè€ƒè™‘å‘¨æ¬¡ï¼**

```python
def optimize_conflicts(version_id, results, task_classes, ...):
    """ä¼˜åŒ–å†²çªè¯¾ç¨‹"""

    # âŒ æ„å»ºå·²å ç”¨æ—¶é—´æ—¶ï¼Œæ²¡æœ‰è®°å½•å‘¨æ¬¡ä¿¡æ¯
    occupied_times = defaultdict(lambda: defaultdict(set))

    for result in results:
        # åªè®°å½•äº† (weekday, slot)ï¼Œæ²¡æœ‰è®°å½• weeks
        occupied_times["classroom"][classroom_id].add((weekday, slot))
        occupied_times["teacher"][teacher_id].add((weekday, slot))
        occupied_times["class"][class_id].add((weekday, slot))
```

```python
def find_alternative_time_for_preference(result, ...):
    """ä¸ºè¯¾ç¨‹å¯»æ‰¾æ›¿ä»£æ—¶é—´"""

    # âŒ æ£€æŸ¥æ—¶é—´æ˜¯å¦å¯ç”¨æ—¶ï¼Œåªæ£€æŸ¥æ—¶é—´ä¸æ£€æŸ¥å‘¨æ¬¡
    def check_time_available(weekday, start_slot, slots_count, ...):
        for slot in range(start_slot, start_slot + slots_count):
            time_key = (weekday, slot)
            if time_key in occupied_times["classroom"][classroom_id]:
                return False  # âŒ åº”è¯¥æ£€æŸ¥å‘¨æ¬¡æ˜¯å¦é‡å 
```

#### ğŸ”´ å½±å“åˆ†æ

1. **å¯èƒ½äº§ç”Ÿå‘¨æ¬¡å†²çª**ï¼šä¼˜åŒ–æ—¶å¯èƒ½å°†è¯¾ç¨‹è°ƒæ•´åˆ°çœ‹ä¼¼ç©ºé—²ä½†å‘¨æ¬¡å†²çªçš„æ—¶é—´
2. **ä¸¢å¤±ä¼˜åŒ–æœºä¼š**ï¼šå•åŒå‘¨è¯¾ç¨‹å¯ä»¥å…±äº«æ—¶é—´æ§½ï¼Œä½†ä¼˜åŒ–ç®—æ³•è®¤ä¸ºå†²çªè€Œæ”¾å¼ƒ

#### ä¿®å¤æ–¹æ¡ˆ

éœ€è¦é‡æ„ `occupied_times` æ•°æ®ç»“æ„ï¼š

```python
# å½“å‰ï¼šoccupied_times[type][id] = Set[(weekday, slot)]
# åº”æ”¹ä¸ºï¼šoccupied_times[type][id] = Dict[(weekday, slot), Set[weeks]]

# æ£€æŸ¥æ—¶é—´å¯ç”¨æ€§æ—¶ï¼š
def check_time_available(..., weeks):
    for slot in range(start_slot, start_slot + slots_count):
        time_key = (weekday, slot)
        if time_key in occupied_times["classroom"][classroom_id]:
            occupied_weeks = occupied_times["classroom"][classroom_id][time_key]
            if len(weeks & occupied_weeks) > 0:  # å‘¨æ¬¡é‡å 
                return False
    return True
```

---

### 5. ç»“æœå¯¼å‡º (`view_schedule.py`)

#### âœ… å·²å®Œå–„æ”¯æŒ

```python
def format_weeks(weeks_str, start_week, end_week, week_pattern):
    """æ ¼å¼åŒ–å‘¨æ¬¡æ˜¾ç¤º"""
    # âœ… ä¼˜å…ˆä½¿ç”¨ offering_weeks æ•°æ®
    if weeks_str:
        # æ ¼å¼åŒ–ä¸º "1-8,10-16å‘¨"

    # âœ… å›é€€åˆ° week_pattern
    if week_pattern == "SINGLE":
        return f"{start_week}-{end_week}å‘¨(å•)"
    elif week_pattern == "DOUBLE":
        return f"{start_week}-{end_week}å‘¨(åŒ)"
```

#### âœ… æ‰€æœ‰è§†è§’éƒ½æ˜¾ç¤ºå‘¨æ¬¡

- æŒ‰æ—¥è§†è§’ âœ…
- æ•™å¸ˆè§†è§’ âœ…
- ç­çº§è§†è§’ âœ…
- æ•™å®¤è§†è§’ âœ…

---

## ä¸‰ã€é—®é¢˜åœºæ™¯åˆ†æ

### åœºæ™¯ 1ï¼šå•åŒå‘¨è¯¾ç¨‹å®‰æ’ âœ… åŸºæœ¬æ”¯æŒ

**ç¤ºä¾‹**ï¼š

```
è¯¾ç¨‹A: é«˜ç­‰æ•°å­¦I (SINGLE) - å•å‘¨ {3,5,7,9,11,13,15,17}
è¯¾ç¨‹B: é«˜ç­‰æ•°å­¦I (DOUBLE) - åŒå‘¨ {4,6,8,10,12,14,16}
```

**æ’è¯¾ç®—æ³•è¡Œä¸º**ï¼š

- âœ… å¦‚æœæ•™å¸ˆä¸åŒã€ç­çº§ä¸åŒï¼šå¯ä»¥å®‰æ’åœ¨åŒä¸€æ—¶é—´
- âš ï¸ å¦‚æœç­çº§ç›¸åŒï¼š**å¯èƒ½ä¼šå†²çª**ï¼ˆç­çº§å†²çªæ£€æµ‹æœªè€ƒè™‘å‘¨æ¬¡ï¼‰

**å®é™…æµ‹è¯•ç»“æœ**ï¼š

```sql
-- å‘¨äº”ç¬¬3-4èŠ‚
æ™ºèƒ½åˆ¶é€ 2025-01ç­ | é«˜ç­‰æ•°å­¦I(SINGLE)  | é™ˆé‡‘å–œ
æ™ºæ…§äº¤é€š2025-01ç­ | é«˜ç­‰æ•°å­¦I(DOUBLE)  | ç†Šå­¦
```

âœ… æ­£å¸¸å·¥ä½œï¼ˆä¸åŒç­çº§ï¼‰

---

### åœºæ™¯ 2ï¼šè¿ç»­å‘¨ä¸å•å‘¨å†²çª âŒ å­˜åœ¨é—®é¢˜

**ç¤ºä¾‹**ï¼š

```
è¯¾ç¨‹A: å†›äº‹æŠ€èƒ½ (CONTINUOUS) - å…¨å­¦æœŸ {1-18}
è¯¾ç¨‹B: é«˜ç­‰æ•°å­¦ (SINGLE) - å•å‘¨ {3,5,7,9,11,13,15,17}
ç­çº§ï¼šæ™ºèƒ½åˆ¶é€ 2025-03ç­
```

**å®é™…å‘ç°çš„å†²çª**ï¼š

```sql
-- å‘¨å››ç¬¬1èŠ‚ï¼Œæ™ºèƒ½åˆ¶é€ 2025-03ç­
å†›äº‹æŠ€èƒ½(CONTINUOUS) | é«˜ç­‰æ•°å­¦I(SINGLE)
```

**åŸå› åˆ†æ**ï¼š

1. âœ… é—ä¼ ç®—æ³•çš„æ•™å¸ˆå†²çªæ£€æµ‹æ­£ç¡®ï¼ˆä¸¤é—¨è¯¾æ•™å¸ˆä¸åŒï¼Œå‘¨æ¬¡é‡å ï¼Œä½†ç­çº§ä¸åŒæ‰€ä»¥å…è®¸ï¼‰
2. âŒ ç­çº§å†²çªæ£€æµ‹ä¸å®Œæ•´ï¼ˆæ²¡æœ‰è·å–ç­çº§å·²æ’è¯¾ç¨‹çš„å‘¨æ¬¡ä¿¡æ¯ï¼‰
3. **ç»“æœ**ï¼šåŒä¸€ç­çº§è¢«å®‰æ’äº†å‘¨æ¬¡é‡å çš„ä¸¤é—¨è¯¾

---

### åœºæ™¯ 3ï¼šå†²çªä¼˜åŒ–å¯èƒ½äº§ç”Ÿæ–°å†²çª ğŸ”´ ä¸¥é‡é—®é¢˜

**ç¤ºä¾‹**ï¼š

```
åˆå§‹çŠ¶æ€ï¼š
- è¯¾ç¨‹A (å•å‘¨) åœ¨ å‘¨ä¸€ 1-2èŠ‚
- è¯¾ç¨‹B (åŒå‘¨) åœ¨ å‘¨ä¸€ 1-2èŠ‚ï¼ˆä¸åŒæ•™å¸ˆã€ä¸åŒç­çº§ï¼‰
- âœ… æ— å†²çª

ä¼˜åŒ–ç®—æ³•è¿è¡Œåï¼š
- ä¼˜åŒ–ç®—æ³•è®¤ä¸º å‘¨ä¸€ 1-2èŠ‚ è¢«å ç”¨
- å°†æŸä¸ªå†²çªè¯¾ç¨‹Cè°ƒæ•´åˆ° å‘¨ä¸€ 1-2èŠ‚
- è¯¾ç¨‹Cæ˜¯å…¨å­¦æœŸè¯¾ç¨‹
- ğŸ”´ äº§ç”Ÿæ–°å†²çªï¼ï¼ˆä¸è¯¾ç¨‹Aå’ŒBéƒ½å†²çªï¼‰
```

**åŸå› **ï¼š

- ä¼˜åŒ–ç®—æ³•çš„ `occupied_times` åªè®°å½•æ—¶é—´ï¼Œä¸è®°å½•å‘¨æ¬¡
- è®¤ä¸º "å‘¨ä¸€ 1-2 èŠ‚" è¢«å ç”¨ï¼Œå®é™…ä¸Šåªæœ‰ç‰¹å®šå‘¨æ¬¡è¢«å ç”¨

---

### åœºæ™¯ 4ï¼šè‡ªå®šä¹‰å‘¨æ¬¡ âš ï¸ éƒ¨åˆ†æ”¯æŒ

**ç¤ºä¾‹**ï¼š

```sql
-- offering_weeks è¡¨
offering_id=99, weeks={1,3,5,8,10,12,15}  -- ä¸è§„åˆ™å‘¨æ¬¡
```

**æ”¯æŒæƒ…å†µ**ï¼š

- âœ… æ•°æ®åŠ è½½ï¼šæ­£ç¡®åŠ è½½è‡ªå®šä¹‰å‘¨æ¬¡
- âœ… å†²çªåˆ†æï¼šæ­£ç¡®æ£€æµ‹å‘¨æ¬¡é‡å 
- âš ï¸ æ’è¯¾ç®—æ³•ï¼šåªè¦ task.weeks æ­£ç¡®ï¼Œå°±èƒ½æ­£å¸¸å·¥ä½œ
- âŒ å†²çªä¼˜åŒ–ï¼šæ— æ³•è¯†åˆ«è‡ªå®šä¹‰å‘¨æ¬¡ï¼Œå¯èƒ½äº§ç”Ÿå†²çª

---

## å››ã€ä¿®å¤ä¼˜å…ˆçº§

### ğŸ”´ P0 - ç´§æ€¥ï¼ˆå½±å“æ­£ç¡®æ€§ï¼‰

1. **ä¿®å¤ç­çº§å†²çªæ£€æµ‹** (`genetic_algorithm.py`)

   - åœ¨ `_has_time_conflict` ä¸­æ£€æŸ¥ç­çº§æ—¶ä¹Ÿè€ƒè™‘å‘¨æ¬¡
   - éœ€è¦å»ºç«‹ `class_schedule_with_weeks` æ•°æ®ç»“æ„

2. **ä¿®å¤å†²çªä¼˜åŒ–ç®—æ³•** (`analyze_conflicts.py`)
   - é‡æ„ `occupied_times` åŒ…å«å‘¨æ¬¡ä¿¡æ¯
   - ä¿®æ”¹ `check_time_available` æ£€æŸ¥å‘¨æ¬¡é‡å 

### ğŸŸ¡ P1 - é‡è¦ï¼ˆæå‡å‡†ç¡®æ€§ï¼‰

3. **æ•™å®¤å‘¨æ¬¡æ£€æµ‹** (`genetic_algorithm.py`)

   - åœ¨æ•™å®¤é€‰æ‹©æ—¶è€ƒè™‘å‘¨æ¬¡
   - å…è®¸å•åŒå‘¨è¯¾ç¨‹å…±äº«æ•™å®¤

4. **å¢å¼ºæ—¥å¿—** (`db_connector.py`, `analyze_conflicts.py`)
   - æ ‡è®°ç¼ºå°‘å‘¨æ¬¡ä¿¡æ¯çš„è¯¾ç¨‹
   - è¾“å‡ºå‘¨æ¬¡ç”Ÿæˆçš„è¯¦ç»†ä¿¡æ¯

### ğŸŸ¢ P2 - ä¼˜åŒ–ï¼ˆç”¨æˆ·ä½“éªŒï¼‰

5. **å‘¨æ¬¡èŒƒå›´é…ç½®**

   - å°† 1-18 å‘¨æ”¹ä¸ºå¯é…ç½®
   - ä» semester è¡¨æˆ–é…ç½®æ–‡ä»¶è¯»å–

6. **å‘¨æ¬¡éªŒè¯**
   - åœ¨æ•°æ®åŠ è½½æ—¶éªŒè¯å‘¨æ¬¡èŒƒå›´åˆç†æ€§
   - æ£€æŸ¥ offering_weeks ä¸ week_pattern çš„ä¸€è‡´æ€§

---

## äº”ã€å»ºè®®çš„ä¿®å¤ä»£ç 

### ä¿®å¤ 1ï¼šç­çº§å†²çªæ£€æµ‹

```python
# genetic_algorithm.py

def _has_time_conflict(
    self,
    teacher_id: str,
    class_ids: List[str],
    weekday: int,
    start_slot: int,
    slots_count: int,
    teacher_schedule: Dict,
    class_schedule: Dict,
    task_id: str = None,
    weeks: Set[int] = None,
    class_schedule_with_weeks: Dict = None,  # æ–°å¢å‚æ•°
) -> bool:
    """æ£€æŸ¥æ—¶é—´å†²çª - å®Œæ•´è€ƒè™‘å‘¨æ¬¡"""

    time_slots = {(weekday, slot) for slot in range(start_slot, start_slot + slots_count)}

    # æ£€æŸ¥æ•™å¸ˆå†²çªï¼ˆå·²è€ƒè™‘å‘¨æ¬¡ï¼‰
    if task_id and task_id in self.task_dict:
        task = self.task_dict[task_id]
        for tid in task.teachers:
            if teacher_schedule[tid] & time_slots:
                if weeks is None or task.weeks is None or len(task.weeks & weeks) > 0:
                    return True

    # æ£€æŸ¥ç­çº§å†²çªï¼ˆæ–°å¢ï¼šè€ƒè™‘å‘¨æ¬¡ï¼‰
    if class_schedule_with_weeks:
        for class_id in class_ids:
            for time_key in time_slots:
                if time_key in class_schedule_with_weeks[class_id]:
                    # è·å–è¯¥ç­çº§åœ¨è¯¥æ—¶é—´çš„æ‰€æœ‰è¯¾ç¨‹çš„å‘¨æ¬¡
                    for other_weeks in class_schedule_with_weeks[class_id][time_key]:
                        if weeks and len(weeks & other_weeks) > 0:
                            return True
    else:
        # æ—§é€»è¾‘ï¼šä¿å®ˆæ£€æµ‹
        for class_id in class_ids:
            if class_schedule[class_id] & time_slots:
                return True

    return False
```

### ä¿®å¤ 2ï¼šå†²çªä¼˜åŒ–ç®—æ³•

```python
# analyze_conflicts.py

def optimize_conflicts(...):
    """ä¼˜åŒ–å†²çª - è€ƒè™‘å‘¨æ¬¡"""

    # æ„å»ºå·²å ç”¨æ—¶é—´ï¼ˆåŒ…å«å‘¨æ¬¡ä¿¡æ¯ï¼‰
    occupied_times = defaultdict(lambda: defaultdict(lambda: defaultdict(set)))
    # ç»“æ„: occupied_times[type][id][(weekday, slot)] = Set[weeks]

    for result in results:
        if result["schedule_id"] in conflict_schedule_ids:
            continue

        weekday = result["week_day"]
        start_slot = result["start_slot"]
        end_slot = start_slot + result["slots_count"] - 1
        weeks = get_weeks(result)  # è·å–å‘¨æ¬¡

        for slot in range(start_slot, end_slot + 1):
            time_key = (weekday, slot)

            # è®°å½•æ•™å®¤å ç”¨ï¼ˆå«å‘¨æ¬¡ï¼‰
            occupied_times["classroom"][classroom_id][time_key].update(weeks)

            # è®°å½•æ•™å¸ˆå ç”¨ï¼ˆå«å‘¨æ¬¡ï¼‰
            for teacher_id in teacher_ids:
                occupied_times["teacher"][teacher_id][time_key].update(weeks)

            # è®°å½•ç­çº§å ç”¨ï¼ˆå«å‘¨æ¬¡ï¼‰
            for class_id in class_ids:
                occupied_times["class"][class_id][time_key].update(weeks)
```

---

## å…­ã€æ€»ç»“

| æ¨¡å—          | å‘¨æ¬¡æ”¯æŒ    | é—®é¢˜                   | å½±å“  |
| ------------- | ----------- | ---------------------- | ----- |
| æ•°æ®åŠ è½½      | âœ… å®Œæ•´     | âš ï¸ é»˜è®¤å€¼ç¡¬ç¼–ç         | ä½    |
| é—ä¼ ç®—æ³•-æ•™å¸ˆ | âœ… å®Œæ•´     | -                      | æ—     |
| é—ä¼ ç®—æ³•-ç­çº§ | âŒ ç¼ºå¤±     | ç­çº§å†²çªæ£€æµ‹ä¸è€ƒè™‘å‘¨æ¬¡ | ğŸ”´ é«˜ |
| é—ä¼ ç®—æ³•-æ•™å®¤ | âŒ ç¼ºå¤±     | æ•™å®¤å†²çªæ£€æµ‹ä¸è€ƒè™‘å‘¨æ¬¡ | ğŸŸ¡ ä¸­ |
| å†²çªåˆ†æ      | âœ… å®Œæ•´     | -                      | æ—     |
| å†²çªä¼˜åŒ–      | âŒ å®Œå…¨ç¼ºå¤± | å¯èƒ½äº§ç”Ÿæ–°å†²çª         | ğŸ”´ é«˜ |
| ç»“æœå¯¼å‡º      | âœ… å®Œæ•´     | -                      | æ—     |

**æ ¸å¿ƒé—®é¢˜**ï¼š

1. ğŸ”´ ç­çº§å†²çªæ£€æµ‹ç¼ºå°‘å‘¨æ¬¡åˆ¤æ–­ï¼ˆå·²å‘ç°å®é™…å†²çªæ¡ˆä¾‹ï¼‰
2. ğŸ”´ å†²çªä¼˜åŒ–ç®—æ³•å®Œå…¨ä¸è€ƒè™‘å‘¨æ¬¡ï¼ˆå¯èƒ½äº§ç”Ÿæ–°å†²çªï¼‰
3. ğŸŸ¡ æ•™å®¤å†²çªæ£€æµ‹ä¸è€ƒè™‘å‘¨æ¬¡ï¼ˆæµªè´¹èµ„æºï¼‰

**å»ºè®®**ï¼š
ä¼˜å…ˆä¿®å¤ P0 çº§é—®é¢˜ï¼Œç„¶åé‡æ–°æ’è¯¾éªŒè¯ã€‚
