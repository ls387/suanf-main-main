# 未满足约束分析与优化建议功能说明

## 功能概述

`show_unsatisfied_constraints.py` 是一个全面的排课质量分析工具，用于检查和显示排课结果中**未满足的软约束**，并提供详细的优化建议。

与 `analyze_conflicts.py` 的区别：

- `analyze_conflicts.py`: 检查**硬约束冲突**（教师冲突、班级冲突、教室冲突等）
- `show_unsatisfied_constraints.py`: 分析**软约束满足度**（偏好、利用率、负荷等），提供优化方向

---

## 使用方法

### 基本用法

```bash
python show_unsatisfied_constraints.py <version_id>
```

### 示例

```bash
# 分析版本1的排课质量
python show_unsatisfied_constraints.py 1

# 分析版本2的排课质量
python show_unsatisfied_constraints.py 2
```

---

## 分析内容

### 1. 教师个性化偏好分析

检查教师设置的偏好时间是否被满足：

- **AVOIDED（避免时段）**: 教师希望避免的时间段，但课程仍被安排在该时段
- **PREFERRED（偏好时段）**: 教师希望的时间段，但课程未安排在该时段

**输出示例**：

```
【1. 教师个性化偏好分析】
----------------------------------------------------------------------

⚠️  违反避免时段: 3 处
  1. 张三 - 高等数学
     实际: 周二 3-5节 (N201)
     避免: 周二 3-5节
     惩罚分数: 200
```

**优化建议**：

- 调整该课程到其他时间段
- 如果无法调整，降低该偏好的 `penalty_score`
- 检查是否与硬约束冲突

---

### 2. 教室容量利用率分析

检查教室使用效率：

- **利用率 < 50%**: 教室太大，座位浪费严重
- **利用率 ≥ 90%**: 教室较为拥挤

**输出示例**：

```
【2. 教室容量利用率分析】
----------------------------------------------------------------------

⚠️  教室利用率低(<50%): 15 处
  (建议更换为容量更小的教室)
  1. 计算机网络 - N501
     周三 6-8节
     容量:120 学生:35 利用率:29.2% 浪费:85座
```

**优化建议**：

- 更换为容量更合适的教室
- 调整遗传算法的 `utilization_waste` 惩罚分数
- 考虑合班以提高利用率

---

### 3. 学生每日课时负荷分析

检查班级每天的课时数是否过多（≥8 节）：

**输出示例**：

```
【3. 学生每日课时负荷分析】
----------------------------------------------------------------------

⚠️  学生每日课时过多(≥8节): 5 处
  1. 计科2023-1班 - 周二
     共10节，4门课程
     课程: 高等数学, 数据结构, 英语
```

**优化建议**：

- 将部分课程调整到其他日期
- 增加 `student_overload` 惩罚分数
- 检查是否为合班导致

---

### 4. 课程任务关系约束分析

检查同一课程不同任务次之间的时间关系是否满足：

- **REQUIRE_SAME_DAY**: 要求同一天，但未满足
- **AVOID_CONSECUTIVE_DAYS**: 要求避免连续天，但违反
- **MIN_DAYS_APART**: 要求最小间隔天数，但未满足

**输出示例**：

```
【4. 课程任务关系约束分析】
----------------------------------------------------------------------

⚠️  任务关系约束未满足: 8 处
  1. 计算机网络 - MIN_DAYS_APART
     要求至少间隔2天，实际间隔1天
     第1次: 周一 第3节, 第2次: 周二 第6节
     惩罚分数: 300
```

**优化建议**：

- 调整课程时间以满足间隔要求
- 增加 `task_relation` 惩罚分数
- 如果要求过严，调整 `constraint_value`

---

### 5. 课程时段偏好分析

检查课程性质与时段的合理性：

- **必修/通识课在晚上（11-13 节）**: 不建议
- **必修课在周末**: 不建议
- **选修课占用黄金时段（上午、下午前半段）**: 轻微问题

**输出示例**：

```
【5. 课程时段偏好分析】
----------------------------------------------------------------------

⚠️  必修/通识课安排在晚上: 3 处
  1. 高等数学A (必修)
     周三 11-13节

⚠️  必修课安排在周末: 2 处
  1. 大学英语 (必修)
     周六 3-5节
```

**优化建议**：

- 将必修课调整到工作日白天
- 增加 `required_night_penalty` 和 `required_weekend_penalty` 分数
- 选修课可以安排在晚上和周末

---

### 6. 教室连续性分析

检查同一门课程是否在固定教室上课：

**输出示例**：

```
【6. 教室连续性分析】
----------------------------------------------------------------------

💡 同一课程使用多个教室: 12 门课程
  1. 数据结构
     使用了3个教室: N301(2次), N302(1次), N401(1次)
```

**优化建议**：

- 增加 `classroom_continuity` 惩罚分数
- 尽量为课程分配固定教室
- 检查是否因教室容量问题导致

---

### 7. 教师跨校区通勤分析

检查教师是否在同一时段（上午/下午/晚上）需要跨校区：

**输出示例**：

```
【7. 教师跨校区通勤分析】
----------------------------------------------------------------------

⚠️  教师需跨校区: 4 处
  1. 李四
     周三下午 跨2个校区
     校区: 南校区, 北校区
     课程: 数据库原理, 计算机网络
```

**优化建议**：

- 将同一教师的课程集中在同一校区
- 增加 `campus_commute` 惩罚分数
- 考虑增加教师资源，减少跨校区授课

---

## 输出报告

### 控制台输出

运行后会在控制台显示：

- 7 个维度的详细分析
- 每个问题的前 5-10 个示例
- 总体统计信息
- 优化建议总结

### Excel 报告

自动生成包含以下工作表的 Excel 文件：

1. **教师偏好违反**: 所有违反教师偏好的详情
2. **教室利用率低**: 利用率<50%的教室列表
3. **学生负荷过重**: 每日 ≥8 节课的班级
4. **任务关系约束违反**: 未满足的任务关系约束
5. **课程时段问题**: 必修课在晚上/周末的情况

文件命名格式：`未满足约束详细报告_版本<id>_<时间戳>.xlsx`

---

## 优化建议总结

程序会在最后给出综合优化建议：

### 1. 调整遗传算法参数

```python
# 在遗传算法配置中调整
"penalty_scores": {
    "teacher_preference": 100,      # 教师偏好 → 增加到 150-200
    "classroom_continuity": 300,    # 教室连续性 → 增加到 400-500
    "utilization_waste": 200,       # 利用率浪费 → 增加到 300-400
    "student_overload": 150,        # 学生过载 → 增加到 200-300
    "task_relation": 300,           # 任务关系 → 保持或增加
    "required_night_penalty": 400,  # 必修课晚上 → 增加到 500-600
    "campus_commute": -5000,        # 跨校区 → 保持硬约束
}
```

### 2. 增加算法参数

```bash
# 运行时使用更大参数
python suan2.py --version 1 --population 300 --generations 200
```

### 3. 调整数据

- **教师偏好**: 放宽时间范围，降低 `penalty_score`
- **任务关系**: 调整 `constraint_value`，放宽间隔要求
- **教室资源**: 增加合适容量的教室数量

---

## 典型工作流程

### 第一次排课后

```bash
# 1. 检查硬约束冲突
python analyze_conflicts.py 1

# 2. 如果有冲突，执行优化
# (按提示操作)

# 3. 检查软约束满足度
python show_unsatisfied_constraints.py 1

# 4. 根据报告调整参数

# 5. 重新排课
python suan2.py --version 2 --population 300 --generations 200

# 6. 重复2-5直到满意
```

### 迭代优化

每次排课后都运行此工具，观察改进情况：

```bash
# 版本1
python show_unsatisfied_constraints.py 1

# 调整参数后，版本2
python show_unsatisfied_constraints.py 2

# 对比改进情况
```

---

## 常见问题

### Q1: 所有硬约束都满足了，但软约束满足率很低怎么办？

**A**: 这是正常的，可以：

1. 增加遗传算法的迭代次数和种群大小
2. 调整惩罚分数，突出最重要的约束
3. 放宽部分不太重要的约束
4. 增加资源（教室、时间段）

### Q2: 教师偏好总是无法满足？

**A**: 可能原因：

1. 偏好时间段太窄，建议扩大范围
2. 与其他硬约束冲突
3. `penalty_score` 设置太低，算法认为违反代价不大
4. 教室资源在该时段不足

### Q3: 教室利用率低能否自动优化？

**A**: 可以：

1. 增加 `utilization_waste` 惩罚分数到 400-500
2. 减少大容量教室的数量
3. 使用 `analyze_conflicts.py` 的容量优化功能

### Q4: 如何判断排课质量是否足够好？

**A**: 参考标准：

- ✅ **优秀**: 软约束满足率 > 90%
- 👍 **良好**: 软约束满足率 80-90%
- ⚠️ **一般**: 软约束满足率 60-80%
- ❌ **较差**: 软约束满足率 < 60%

### Q5: 能否只优化某一个维度的问题？

**A**: 可以，调整惩罚分数：

```python
# 只关注教师偏好
"teacher_preference": 1000,  # 大幅提高
"utilization_waste": 50,     # 大幅降低其他
"student_overload": 50,
```

---

## 与其他工具的配合使用

### 与 analyze_conflicts.py 配合

```bash
# 先解决硬约束
python analyze_conflicts.py 1

# 再优化软约束
python show_unsatisfied_constraints.py 1
```

### 与 view_schedule.py 配合

```bash
# 查看未满足约束的具体课程
python show_unsatisfied_constraints.py 1

# 查看该课程的完整课表
python view_schedule.py --version 1 --course "高等数学"
```

---

## 总结

`show_unsatisfied_constraints.py` 是排课质量优化的重要工具，它能：

✅ 全面分析 7 个维度的软约束满足情况
✅ 提供详细的 Excel 报告供深入分析
✅ 给出具体的优化建议和参数调整方向
✅ 帮助迭代改进排课方案质量

**建议每次排课后都运行此工具，持续优化排课质量！**
