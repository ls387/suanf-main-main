# 排课问题诊断与解决方案

本文档提供针对各种排课结果不理想情况的诊断方法和解决措施。

---

## 一、班级冲突问题

### 现象

- 同一班级在同一时间被安排了多门课程
- Excel 导出的班级视角显示时间重叠

### 诊断步骤

```powershell
# 1. 查看冲突分析报告
python analyze_conflicts.py 1

# 2. 检查日志中的班级冲突修复情况
Get-Content scheduling.log | Select-String "班级冲突"
```

### 解决方案

#### 方案 A：提高算法参数（推荐首选）

```powershell
# 增加种群和代数，给算法更多探索空间
python suan2.py --version 2 --population 300 --generations 500
```

#### 方案 B：增加班级冲突惩罚权重

编辑 `genetic_algorithm.py`，找到 `penalty_scores` 配置：

```python
"class_conflict": -100000,  # 从 -80000 提升到 -100000
```

#### 方案 C：检查数据完整性

```sql
-- 检查是否有班级未正确关联到课程
SELECT co.offering_id, co.course_id, COUNT(oc.class_id) as class_count
FROM course_offerings co
LEFT JOIN offering_classes oc ON co.offering_id = oc.offering_id
GROUP BY co.offering_id
HAVING class_count = 0;

-- 检查班级是否有过多课程
SELECT cl.class_name, COUNT(DISTINCT oc.offering_id) as course_count
FROM classes cl
JOIN offering_classes oc ON cl.class_id = oc.class_id
GROUP BY cl.class_name
ORDER BY course_count DESC;
```

#### 方案 D：分批次排课

如果班级课程过多，考虑分批次：

```powershell
# 第一批：必修课
python suan2.py --version 2 --population 200 --generations 300

# 第二批：选修课（在第一批基础上补充）
```

---

## 二、教室容量不足问题

### 现象

- 分配的教室容量小于上课人数
- 适应度分数中 capacity_violation 惩罚很高

### 诊断步骤

```sql
-- 检查教室容量分布
SELECT
    CASE
        WHEN capacity < 30 THEN '小型(<30)'
        WHEN capacity < 60 THEN '中型(30-60)'
        WHEN capacity < 100 THEN '大型(60-100)'
        ELSE '超大型(>100)'
    END as size_category,
    COUNT(*) as classroom_count
FROM classrooms
GROUP BY size_category;

-- 检查课程人数分布
SELECT
    CASE
        WHEN student_count_estimate < 30 THEN '小班(<30)'
        WHEN student_count_estimate < 60 THEN '中班(30-60)'
        WHEN student_count_estimate < 100 THEN '大班(60-100)'
        ELSE '超大班(>100)'
    END as class_size,
    COUNT(*) as offering_count
FROM course_offerings
GROUP BY class_size;
```

### 解决方案

#### 方案 A：增加合适容量的教室

```sql
-- 添加更多大容量教室
INSERT INTO classrooms (classroom_id, classroom_name, capacity, campus, building, features)
VALUES
('CR_L001', '大阶梯教室1', 150, '主校区', '教学楼A', ''),
('CR_L002', '大阶梯教室2', 120, '主校区', '教学楼B', '');
```

#### 方案 B：拆分大班课程

```sql
-- 将大班课程拆分为多个小组
INSERT INTO teaching_tasks (offering_id, group_id, slots_count)
SELECT offering_id, 2, slots_count
FROM teaching_tasks
WHERE offering_id IN (
    SELECT offering_id FROM course_offerings WHERE student_count_estimate > 100
);
```

#### 方案 C：提高容量惩罚（已优化为 -60000）

确认当前配置：

```python
"capacity_violation": -60000,  # 极高惩罚
```

---

## 三、教室利用率过低问题

### 现象

- 平均利用率 < 60%
- 大量小班占用大教室

### 诊断步骤

```powershell
# 查看结果统计
python view_schedule.py 1

# 分析利用率分布
python analyze_conflicts.py 1
```

### 解决方案

#### 方案 A：调整利用率目标区间

编辑 `genetic_algorithm.py` 中的 `_select_classroom` 方法：

```python
# 当前理想利用率：75%-90%
# 可调整为更激进的目标：80%-95%
if 0.80 <= utilization <= 0.95:
    return abs(0.875 - utilization)
```

#### 方案 B：增加利用率惩罚权重

```python
"utilization_waste": 400,  # 从 200 提升到 400
```

#### 方案 C：优化教室容量配置

```sql
-- 添加更多小型教室（20-40人）
INSERT INTO classrooms (classroom_id, classroom_name, capacity, campus, building)
VALUES
('CR_S001', '小教室1', 25, '主校区', '教学楼C'),
('CR_S002', '小教室2', 30, '主校区', '教学楼C'),
('CR_S003', '小教室3', 35, '主校区', '教学楼C');
```

---

## 四、教师时间冲突问题

### 现象

- 同一教师在同一时间被分配多门课
- 教师负荷过重

### 诊断步骤

```sql
-- 检查教师课程负荷
SELECT
    t.teacher_name,
    COUNT(DISTINCT ot.offering_id) as course_count,
    SUM(tt.slots_count) as total_slots
FROM teachers t
JOIN offering_teachers ot ON t.teacher_id = ot.teacher_id
JOIN teaching_tasks tt ON ot.offering_id = tt.offering_id
GROUP BY t.teacher_id
ORDER BY total_slots DESC;
```

### 解决方案

#### 方案 A：增加可授课教师

```sql
-- 为课程添加更多可选教师
INSERT INTO offering_teachers (offering_id, teacher_id)
SELECT DISTINCT co.offering_id, t.teacher_id
FROM course_offerings co
CROSS JOIN teachers t
WHERE t.teacher_id NOT IN (
    SELECT teacher_id FROM offering_teachers WHERE offering_id = co.offering_id
)
AND t.专业方向 = co.课程类别;  -- 根据实际业务逻辑匹配
```

#### 方案 B：设置教师黑名单时间

```sql
-- 为负荷重的教师设置休息时间
INSERT INTO teacher_blackout_times (teacher_id, week_day, start_slot, end_slot, reason)
VALUES
(1, 3, 11, 13, '科研时间'),  -- 周三晚上
(2, 5, 9, 10, '会议时间');   -- 周五上午
```

#### 方案 C：调整教师冲突惩罚

```python
"teacher_conflict": -70000,  # 从 -50000 提升到 -70000
```

---

## 五、教室/教师连续性差问题

### 现象

- 同一教师/班级连续课程在不同教室
- 师生频繁换教室

### 诊断步骤

```powershell
# 查看Excel导出的教师/班级视角
python view_schedule.py 1
# 检查同一天的连续课程是否在同一教室
```

### 解决方案

#### 方案 A：提高连续性惩罚权重（已优化为 300）

```python
"classroom_continuity": 500,  # 从 300 提升到 500，更强烈鼓励
```

#### 方案 B：增加算法迭代次数

```powershell
# 给算法更多机会优化连续性
python suan2.py --version 2 --population 200 --generations 400
```

#### 方案 C：手动锁定部分教室

为特定课程指定固定教室（需修改代码添加此功能）：

```sql
-- 在 course_offerings 表添加 preferred_classroom_id 字段
ALTER TABLE course_offerings ADD COLUMN preferred_classroom_id VARCHAR(20);

-- 为长期课程指定固定教室
UPDATE course_offerings
SET preferred_classroom_id = 'CR001'
WHERE course_id = 'C001';
```

---

## 六、周末/晚上排课过多问题

### 现象

- 必修课被安排在周末或晚上
- 违反学生作息习惯

### 诊断步骤

```sql
-- 统计周末课程
SELECT COUNT(*) as weekend_count
FROM schedules
WHERE week_day IN (6, 7);

-- 统计晚上课程（11-13节）
SELECT COUNT(*) as night_count
FROM schedules
WHERE start_slot >= 11;
```

### 解决方案

#### 方案 A：提高周末/晚上惩罚（已优化）

当前配置：

```python
"weekend_penalty": -10000,           # 周末硬约束
"required_night_penalty": 400,       # 必修课晚上惩罚
"required_weekend_penalty": 300,     # 必修课周末惩罚
```

如需进一步限制：

```python
"weekend_penalty": -50000,           # 完全禁止周末
"required_night_penalty": 1000,      # 大幅提高
```

#### 方案 B：减少周末/晚上时间段

编辑 `data_models.py` 的 `get_valid_time_windows()`：

```python
# 完全移除周末和晚上时段
valid_windows = [
    (day, start, end)
    for day, start, end in TIME_WINDOWS
    if day <= 5 and start < 11  # 只保留工作日白天
]
```

---

## 七、特殊教室设施不满足问题

### 现象

- 需要实验室/多媒体的课程被分配到普通教室
- feature_violation 惩罚高

### 诊断步骤

```sql
-- 检查课程设施需求
SELECT c.course_name, co.required_features
FROM course_offerings co
JOIN courses c ON co.course_id = c.course_id
WHERE co.required_features IS NOT NULL AND co.required_features != '';

-- 检查教室设施
SELECT classroom_name, features, capacity
FROM classrooms
WHERE features IS NOT NULL AND features != ''
ORDER BY features;
```

### 解决方案

#### 方案 A：补充特殊教室

```sql
-- 添加实验室
INSERT INTO classrooms (classroom_id, classroom_name, capacity, campus, building, features)
VALUES
('LAB001', '计算机实验室1', 60, '主校区', '实验楼', '计算机,投影仪'),
('LAB002', '物理实验室', 40, '主校区', '实验楼', '实验设备'),
('MM001', '多媒体教室1', 80, '主校区', '教学楼A', '投影仪,音响');
```

#### 方案 B：放宽设施要求

```sql
-- 将部分非强制设施改为可选
UPDATE course_offerings
SET required_features = ''
WHERE course_nature = '选修' AND required_features = '投影仪';
```

#### 方案 C：提高设施违反惩罚

```python
"feature_violation": -20000,  # 从 -8000 提升到 -20000
```

---

## 八、算法运行时间过长问题

### 现象

- 排课运行超过 10 分钟
- CPU/内存占用过高

### 诊断步骤

```powershell
# 检查数据规模
python check_data_scale.py

# 查看推荐参数
```

### 解决方案

#### 方案 A：降低参数（快速模式）

```powershell
# 小规模数据
python suan2.py --version 2 --population 80 --generations 150

# 中等规模数据
python suan2.py --version 2 --population 150 --generations 250 --max-stagnation 40
```

#### 方案 B：启用早停

```powershell
# 设置较小的停滞容忍度
python suan2.py --version 2 --population 200 --generations 500 --max-stagnation 30
```

#### 方案 C：分阶段优化

```powershell
# 第一阶段：快速探索
python suan2.py --version 2 --population 100 --generations 100

# 第二阶段：精细优化（基于第一阶段结果）
python suan2.py --version 3 --population 200 --generations 300
```

---

## 九、覆盖率不足问题

### 现象

- 部分课程无法被排入课表
- 覆盖率 < 95%

### 诊断步骤

```sql
-- 查找未被排课的任务
SELECT tt.task_id, c.course_name, co.student_count_estimate
FROM teaching_tasks tt
JOIN course_offerings co ON tt.offering_id = co.offering_id
JOIN courses c ON co.course_id = c.course_id
WHERE tt.task_id NOT IN (
    SELECT DISTINCT task_id FROM schedules WHERE version_id = 1
);
```

### 解决方案

#### 方案 A：检查资源瓶颈

```sql
-- 检查是否教师不足
SELECT COUNT(DISTINCT teacher_id) as teacher_count FROM teachers;
SELECT COUNT(DISTINCT offering_id) as offering_count FROM course_offerings;

-- 检查是否教室不足
SELECT COUNT(*) as classroom_count FROM classrooms;

-- 检查是否时间段不足
-- 工作日 5天 × 13节 = 65 个时间段
```

#### 方案 B：放宽约束

临时放宽部分软约束以提高覆盖率：

```python
# 降低部分惩罚，让算法更容易找到可行解
"utilization_waste": 100,       # 从 200 降到 100
"classroom_continuity": 150,    # 从 300 降到 150
"teacher_preference": 50,       # 从 100 降到 50
```

#### 方案 C：增加算法探索能力

```powershell
# 大幅增加种群和代数
python suan2.py --version 2 --population 500 --generations 800
```

---

## 十、综合优化策略

### 标准优化流程

```powershell
# 步骤1：诊断当前问题
python analyze_conflicts.py 1
python check_data_scale.py

# 步骤2：根据问题调整参数（选择对应方案）

# 步骤3：重新运行排课
python suan2.py --version 2 --population 250 --generations 400

# 步骤4：验证结果
python view_schedule.py 2
python analyze_conflicts.py 2

# 步骤5：如果仍不理想，迭代调整
```

### 参数调优优先级

1. **首先解决硬约束冲突**（班级/教师/教室冲突、容量不足）
2. **其次优化覆盖率**（确保所有课程都能排上）
3. **然后优化利用率**（教室利用率、连续性）
4. **最后优化软约束**（教师偏好、时段偏好）

### 常用参数组合

```powershell
# 追求质量（时间充足）
python suan2.py --version X --population 300 --generations 500 --max-stagnation 80

# 平衡质量和速度（推荐）
python suan2.py --version X --population 200 --generations 300 --max-stagnation 60

# 快速测试（验证可行性）
python suan2.py --version X --population 80 --generations 100 --max-stagnation 30
```

---

## 十一、紧急救援措施

### 如果所有方案都无效

#### 最后手段 A：手动调整部分课程

```sql
-- 导出当前最佳结果
python view_schedule.py X

-- 在 Excel 中手动调整少量冲突课程

-- 直接修改数据库
UPDATE schedules
SET classroom_id = 'CR005', week_day = 3, start_slot = 6
WHERE schedule_id = 123;
```

#### 最后手段 B：联系开发者调试

保存完整日志和数据库快照：

```powershell
# 导出日志
Copy-Item scheduling.log "debug_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# 导出数据库（供调试）
mysqldump -u pk -p paike > backup_$(Get-Date -Format 'yyyyMMdd').sql
```

---

**使用建议**：按问题类型查找对应章节，从方案 A 开始尝试，逐步升级到方案 B、C，多数问题可通过调整参数解决。
