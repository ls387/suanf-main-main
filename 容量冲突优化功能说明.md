# 容量冲突优化功能说明

## 📋 功能概述

系统现已完整支持**三阶段冲突优化策略**，包括容量冲突检测和优化：

### 三阶段优化策略

1. **第一阶段：解决容量不足冲突**（硬约束，最高优先级）
2. **第二阶段：解决时间冲突**（硬约束）
3. **第三阶段：优化利用率和个性化要求**（软约束）

---

## 🔍 容量冲突检测

### 1. 检测类型

#### **容量不足冲突**（硬约束）

- 检测：教室容量 < 学生人数
- 严重性：❌ **必须解决**
- 示例：30 人班级分配到 25 人教室

#### **容量浪费**（软约束）

- 检测：容量浪费率 > 阈值
- 分级阈值：
  - 小班(<30 人)：最大浪费 50%
  - 中班(30-60)：最大浪费 40%
  - 大班(>60 人)：最大浪费 30%
- 示例：30 人班级使用 100 人教室（浪费 70% > 50%）

### 2. 统计信息

检测报告包含：

- ✅ 容量不足课程数量和详情
- ✅ 总浪费座位数
- ✅ 平均每节课浪费座位
- ✅ 容量浪费严重课程列表（按浪费率排序）

---

## 🛠️ 容量冲突优化

### 第一阶段：容量不足优化

#### 优化策略

1. **识别问题**：列出所有容量不足的课程
2. **寻找替代**：查找同一时间段未被占用且容量足够的教室
3. **选择最优**：选择容量最接近（但足够）的教室，避免过度浪费
4. **应用调整**：更新数据库中的教室分配

#### 优化示例

```
为 高等数学 寻找更大的教室...
  当前教室: A101 (容量45)
  需要容量: 50
  ✓ 找到合适教室: A201 (容量55, 利用率90.9%)
```

#### 优化条件

- ✅ 新教室容量 ≥ 学生人数
- ✅ 新教室在该时间段未被占用
- ✅ 优先选择容量最接近的教室（减少浪费）

### 第三阶段：利用率优化

#### 优化目标

- 目标利用率：**80%-95%**
- 最佳利用率：**87.5%**

#### 优化策略

1. **识别浪费**：找出浪费率超过阈值的课程（前 20 个）
2. **计算目标**：
   - 最小容量：学生数 / 0.95（达到 95%利用率）
   - 最大容量：学生数 / 0.80（达到 80%利用率）
3. **寻找教室**：查找容量在目标范围内且未被占用的教室
4. **选择最优**：选择利用率最接近 87.5%的教室
5. **验证提升**：只有当新利用率至少提升 10%时才调整

#### 优化示例

```
[1] 体育: 周一 第1-2节
    大操场 (容量200, 利用率15%) →
    小操场 (容量40, 利用率75%)
```

---

## 📊 使用方法

### 1. 运行冲突分析

```bash
python analyze_conflicts.py 1
```

### 2. 分析报告示例

```
================================================================================
排课版本 1 冲突分析报告
================================================================================

【教室容量分析】

容量不足冲突: 2 个
  [1] 高等数学: 教室 A101 (容量45) < 学生数50, 缺少 5 个座位
  [2] 大学物理: 教室 B203 (容量58) < 学生数62, 缺少 4 个座位

总计浪费座位数: 1500 个
平均每节课浪费: 12.5 个座位

容量浪费严重课程: 8 个
  [1] 体育: 教室 大操场 (容量200) > 学生数30, 浪费 170 个座位 (浪费率85%, 利用率15%)
  [2] 选修课: 教室 C301 (容量100) > 学生数25, 浪费 75 个座位 (浪费率75%, 利用率25%)
  ...
```

### 3. 优化流程

```
================================================================================
开始优化冲突（三阶段策略）...
第一阶段：解决容量不足冲突（硬约束）
第二阶段：解决教师/班级/教室时间冲突（硬约束）
第三阶段：优化容量利用率和满足个性化要求（软约束）
================================================================================

第一阶段：解决 2 个容量不足冲突...

为 高等数学 寻找更大的教室...
  当前教室: A101 (容量45)
  需要容量: 50
  ✓ 找到合适教室: A201 (容量55, 利用率90.9%)

找到 2 个容量优化方案:
  [1] 高等数学: 周一 第1-2节
      A101 (容量45) → A201 (容量55, 利用率90.9%)

确认应用这些容量优化? (y/n): y
✓ 已应用 2 个容量优化

第二阶段：识别到 4 个有时间冲突的课程安排
...（时间冲突优化）...

第三阶段：优化容量利用率和个性化要求

发现 8 个容量浪费严重的课程，尝试优化...

找到 5 个利用率优化方案:
  [1] 体育: 周一 第1-2节
      大操场 (容量200, 利用率15%) → 小操场 (容量40, 利用率75%)

确认应用这些利用率优化? (y/n): y
✓ 已应用 5 个利用率优化
```

---

## 🎯 优化效果

### 容量不足优化

- ✅ **解决硬约束**：所有学生都有座位
- ✅ **避免安全隐患**：教室容量满足要求
- ✅ **提升排课质量**：符合基本规范

### 利用率优化

- ✅ **减少浪费**：降低空座率
- ✅ **提高效率**：教室资源更充分利用
- ✅ **节约成本**：释放大教室给更需要的课程

### 预期改进

```
优化前：
  容量不足: 5个课程
  平均利用率: 65%
  严重浪费: 15个课程

优化后：
  容量不足: 0个课程 ✓
  平均利用率: 85% ↑
  严重浪费: 3个课程 ↓
```

---

## ⚙️ 技术实现

### 数据库查询

```sql
-- 查询学生总数
SELECT SUM(cl.student_count) as total_students
FROM offering_classes oc
JOIN classes cl ON oc.class_id = cl.class_id
WHERE task_id = ?

-- 查询教室容量
SELECT capacity FROM classrooms WHERE classroom_id = ?

-- 查询占用情况
SELECT DISTINCT classroom_id
FROM schedules
WHERE version_id = ? AND week_day = ?
  AND schedule_id != ?
  AND (时间重叠条件)
```

### 优化算法

```python
# 容量不足：选择最小足够容量
best = min(suitable_rooms, key=lambda r: r['capacity'])

# 利用率优化：选择最接近87.5%利用率
best = min(suitable_rooms,
           key=lambda r: abs(students/r['capacity'] - 0.875))
```

---

## 📝 注意事项

### 1. 容量检测

- ✅ 自动查询每个课程的学生总数
- ✅ 考虑多个班级合班上课的情况
- ✅ 区分容量不足（硬约束）和容量浪费（软约束）

### 2. 优化限制

- ⚠️ 只优化前 20 个浪费最严重的课程（避免过度调整）
- ⚠️ 利用率提升至少 10%才调整（避免微调）
- ⚠️ 不违反任何硬约束（时间冲突、教室特征等）

### 3. 手动确认

- 💡 所有优化方案都需要用户确认
- 💡 可以查看详细的调整前后对比
- 💡 支持取消操作，不会强制修改

---

## 🚀 后续建议

### 自动优化增强

1. 支持批量自动优化（无需逐个确认）
2. 添加优化日志记录
3. 支持回滚到优化前的状态

### 智能推荐

1. 建议最佳教室配置方案
2. 预测优化后的整体利用率
3. 生成优化效果对比报告

### 可视化展示

1. 容量利用率分布图表
2. 优化前后对比可视化
3. 教室使用热力图
